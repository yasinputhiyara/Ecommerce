<%- include("../../partials/header") %>

    <link rel="stylesheet" href="/user/stylesheets/profile.css" />


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            /* background: white; */
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .order-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            display: inline-block;
        }

        .status-wrapper {
            text-align: right;
        }

        .status.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status.cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .status.processing {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status.shipped {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .products-list {
            margin-bottom: 30px;
        }

        .product-item {
            display: grid;
            grid-template-columns: 80px 2fr 1fr 1fr 1fr 1fr ;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .product-header {
            font-weight: 600;
            color: #2c3e50;
            padding-bottom: 15px;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .product-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .product-id {
            font-size: 0.8rem;
            color: #666;
        }

        .address-section,
        .total-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .total-amount {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .back-btn {
            padding: 8px 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }

        .cancel-btn {
            padding: 8px 16px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .cancel-product-btn {
            padding: 4px 8px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .cancel-btn:hover,
        .cancel-product-btn:hover {
            background: #d32f2f;
        }

        .cancelled {
            text-decoration: line-through;
            color: #999;
        }

        .order-timeline {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .timeline-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .timeline-date {
            color: #666;
            min-width: 150px;
        }

        .timeline-status {
            font-weight: 500;
        }
    </style>

    <style>
        .card-stepper {
            z-index: 0
        }

        #progressbar-2 {
            color: #455A64;
        }

        #progressbar-2 li {
            list-style-type: none;
            font-size: 13px;
            width: 33.33%;
            float: left;
            position: relative;
        }

        #progressbar-2 #step1:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-left: 0px;
            padding-left: 0px;
        }

        #progressbar-2 #step2:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
        }

        #progressbar-2 #step3:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-right: 0;
            text-align: center;
        }

        #progressbar-2 #step4:before {
            content: '\f111';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-right: 0;
            text-align: center;
        }

        #progressbar-2 li:before {
            line-height: 37px;
            display: block;
            font-size: 12px;
            background: #c5cae9;
            border-radius: 50%;
        }

        #progressbar-2 li:after {
            content: '';
            width: 100%;
            height: 10px;
            background: #c5cae9;
            position: absolute;
            left: 0%;
            right: 0%;
            top: 15px;
            z-index: -1;
        }

        #progressbar-2 li:nth-child(1):after {
            left: 1%;
            width: 100%
        }

        #progressbar-2 li:nth-child(2):after {
            left: 1%;
            width: 100%;
        }

        #progressbar-2 li:nth-child(3):after {
            left: 1%;
            width: 100%;
            background: #c5cae9 !important;
        }

        #progressbar-2 li:nth-child(4) {
            left: 0;
            width: 37px;
        }

        #progressbar-2 li:nth-child(4):after {
            left: 0;
            width: 0;
        }

        #progressbar-2 li.active:before,
        #progressbar-2 li.active:after {
            background: #6520ff;
        }
    </style>

    <div class="profile-session-container">
        <div class="container-fluid">
            <div class="dashboard">
                <!-- Sidebar -->
                <div class="sidebar">
                    <a href="/dashboard" class="w-100">
                        <button class="nav-button w-100">Dashboard</button>
                    </a>
                    <a href="/orders" class="w-100">
                        <button class="nav-button active w-100">Orders</button>
                    </a>
                    <a href="/update-profile" class="w-100">
                        <button class="nav-button w-100">Update Profile</button>
                    </a>
                    <a href="/address" class="w-100">
                        <button class="nav-button w-100">My Address</button>
                    </a>
                    <a href="/wallet" class="w-100">
                        <button class="nav-button w-100">Wallet</button>
                    </a>
                    <a href="/logout" class="w-100">
                        <button class="nav-button w-100">Logout</button>
                    </a>
                </div>

                <!-- Main Content -->
                <div class="container w-75 h-100 my-5 py-4 rounded shadow-lg bg-light">
                    <h2 class="section-title">Order Details</h2>

                    <div class="container mt-5 pt-5">
                        <div class="order-header">
                            <div class="order-info">
                                <h2 class="order-id">Order #<%= order._id %>
                                </h2>
                                <div class="order-date">
                                    Ordered on: <%= new Date(order.createdOn).toLocaleDateString('en-US', {
                                        weekday: 'long' , year: 'numeric' , month: 'long' , day: 'numeric' ,
                                        hour: '2-digit' , minute: '2-digit' }) %>
                                </div>
                            </div>
                            <div class="status-wrapper">
                                <span class="order-status status <%= order.orderStatus.toLowerCase() %>">
                                    <%= order.orderStatus %>
                                </span>
                            </div>
                        </div>



                        <div class="products-list">
                            <div class="product-item product-header">
                                <div>Image</div>
                                <div>Product Details</div>
                                <div>Size</div>
                                <div>Quantity</div>
                                <div>Price</div>
                                <div>Action</div>
                            </div>
                            <% order.orderedItems.forEach((item, index)=> { %>
                                <div class="product-item <%= item.status === 'Cancelled' ? 'Cancelled' : '' %>">

                                    <div>
                                        <img src="/product-images/<%= item.product.productImages[0] %>"
                                            alt="<%= item.product.productName %>" class="product-image">
                                    </div>
                                    <div class="product-details">
                                        <span class="product-name">
                                            <%= item.product.productName %>
                                        </span>
                                        <span class="product-id">Brand: <%= item.product.brand || 'N/A' %></span>
                                    </div>
                                    <div>
                                        <%= item.size %>
                                    </div>
                                    <div>
                                        <%= item.quantity %>
                                    </div>
                                    <div>₹<%= (item.price * item.quantity).toFixed(2) %>
                                    </div>
                                    <div>
                                        <% if (order.orderStatus.toLowerCase()==='pending' && item.status !=='Cancelled' ) { %>
                                            <button class="cancel-product-btn"
                                                onclick="confirmCancelProduct('<%= order._id %>', `<%= index %>`)">
                                                Cancel Item
                                            </button>
                                            <% } else if (order.orderStatus.toLowerCase()==='processing' && item.status!=='Cancelled' ) { %>
                                                <span class="badge bg-warning text-dark">Processing</span>
                                                <% } else if (order.orderStatus.toLowerCase()==='shipped' && item.status !=='Cancelled' ) { %>
                                                    <span class="badge bg-info text-dark">Shipped</span>
                                                    <% } else if (order.orderStatus.toLowerCase()==='delivered' ) { %>
                                                        <span class="badge bg-success text-white">Delivered</span>
                                                        <% } else if (item.status==='Cancelled' ) { %>
                                                            <a class="badge rounded-pill bg-danger text-white" disabled>
                                                                Item Cancelled
                                                            </a>
                                                            <% } %>
                                    </div>
                                </div>
                                <% }); %>
                        </div>

                        <div class="address-section">
                            <h3 class="section-title">Shipping Address</h3>
                            <p class="text-center">
                                <strong>
                                    <%= orderAddress.name %>
                                </strong> <br>
                                <%= orderAddress.addressType %> Address <br>
                                    <%= orderAddress.landMark %>, <%= orderAddress.city %>, <%= orderAddress.state %> -
                                                <%= orderAddress.pincode %> <br>
                                                    Phone: <%= orderAddress.phone %> <br>
                                                        Alt Phone: <%= orderAddress.altPhone %>
                            </p>
                        </div>


                        <div class="timeline-section">
                            <% if (order.orderStatus.toLowerCase() !=='cancelled' ) { %>
                                <section class="vh-50" style="background-color: #ffffff;">
                                    <div class="container py-5 h-100">
                                        <div class="row d-flex justify-content-center align-items-center h-100">
                                            <div class="col-12">
                                                <div class="card card-stepper" style="border-radius: 16px;">
                                                    <div class="card-body p-5">
                                                        <div
                                                            class="d-flex justify-content-between align-items-center mb-5">
                                                            <div>
                                                                <h5 class="mb-0">ORDER TRACKING</h5>
                                                            </div>
                                                            <div class="text-end">
                                                                <p class="mb-0">Order Date: <%= new
                                                                        Date(order.createdOn).toLocaleDateString() %>
                                                                </p>
                                                                <p class="mb-0">Order ID: #<%= order._id %>
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <% let steps={ 'pending' : 1, 'processing' : 2, 'shipped' :
                                                            3, 'delivered' : 4 }; let
                                                            currentStep=steps[order.orderStatus.toLowerCase()] || 0; %>

                                                            <ul id="progressbar-2"
                                                                class="d-flex justify-content-between mx-0 mt-0 mb-5 px-0 pt-0 pb-2">
                                                                <li class="step0 <%= currentStep >= 1 ? 'active' : '' %> text-center"
                                                                    id="step1"></li>
                                                                <li class="step0 <%= currentStep >= 2 ? 'active' : '' %> text-center"
                                                                    id="step2"></li>
                                                                <li class="step0 <%= currentStep >= 3 ? 'active' : '' %> text-center"
                                                                    id="step3"></li>
                                                                <li class="step0 <%= currentStep >= 4 ? 'active' : '' %> text-end"
                                                                    id="step4"></li>
                                                            </ul>

                                                            <div class="d-flex justify-content-between">
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-clipboard-list fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Pending</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-box-open fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Processing</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-shipping-fast fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Shipped</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-home fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Delivered</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <% } %>
                        </div>



                        <div class="total-section">
                            <h3 class="section-title">Total Amount</h3>
                            <p class="total-amount text-center">₹<%= order.totalPrice.toFixed(2) %>
                            </p>
                        </div>

                        <a href="/orders" class="back-btn">Back to Orders</a>
                        <% if (order.orderStatus.toLowerCase()==='pending' ) { %>
                            <button class="cancel-btn" onclick="confirmCancelOrder('<%= order._id %>')">Cancel
                                Order</button>
                            <% } %>
                    </div>

                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmCancelOrder(orderId) {
            // First check if order status is shipped
            const orderStatus = '<%= order.orderStatus.toLowerCase() %>';
            if (orderStatus === 'shipped' || orderStatus === 'delivered') {
                Swal.fire({
                    title: 'Cannot Cancel',
                    text: 'Orders cannot be cancelled once shipped',
                    icon: 'error',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: 'Cancel Entire Order?',
                text: `Are you sure you want to cancel order ${orderId}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel order',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelOrder(orderId);
                }
            });
        }

        function confirmCancelProduct(orderId, productIndex) {
            // First check if order status is shipped
            const orderStatus = '<%= order.orderStatus.toLowerCase() %>';
            if (orderStatus === 'shipped' || orderStatus === 'delivered') {
                Swal.fire({
                    title: 'Cannot Cancel',
                    text: 'Products cannot be cancelled once the order is shipped',
                    icon: 'error',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: 'Cancel Product?',
                text: 'Are you sure you want to cancel this product?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel item',
                cancelButtonText: 'No, keep it'
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelProduct(orderId, productIndex);
                }
            });
        }


        function cancelOrder(orderId) {
            fetch(`/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Cancelled!', 'The order has been cancelled.', 'success')
                            .then(() => {
                                window.location.reload();
                            });
                    } else {
                        Swal.fire('Error!', 'Failed to cancel the order.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error!', 'Something went wrong.', 'error');
                });
        }

        function cancelProduct(orderId, productIndex) {
            fetch(`/orders/${orderId}/products/${productIndex}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        Swal.fire('Cancelled!', 'The product has been cancelled.', 'success')
                            .then(() => {
                                window.location.reload();
                            });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error!', error.message || 'Something went wrong.', 'error');
                });
        }
    </script>

    <%- include("../../partials/footer") %>