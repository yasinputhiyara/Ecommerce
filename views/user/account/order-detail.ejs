<%- include("../../partials/header") %>

    <link rel="stylesheet" href="/user/stylesheets/profile.css" />


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            /* background: white; */
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .order-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            display: inline-block;
        }

        .status-wrapper {
            text-align: right;
        }

        .status.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status.cancelled {
            background: #ffebee;
            color: #c62828;
        }

        .status.processing {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status.shipped {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .products-list {
            margin-bottom: 30px;
        }

        .product-item {
            display: grid;
            grid-template-columns: 80px 2fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .product-header {
            font-weight: 600;
            color: #2c3e50;
            padding-bottom: 15px;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .product-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .product-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .product-id {
            font-size: 0.8rem;
            color: #666;
        }

        .address-section,
        .total-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .total-amount {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .back-btn {
            padding: 8px 16px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
        }

        .cancel-btn {
            padding: 8px 16px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .cancel-product-btn {
            padding: 4px 8px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .cancel-btn:hover,
        .cancel-product-btn:hover {
            background: #d32f2f;
        }

        .cancelled {
            text-decoration: line-through;
            color: #999;
        }

        .order-timeline {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .timeline-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .timeline-date {
            color: #666;
            min-width: 150px;
        }

        .timeline-status {
            font-weight: 500;
        }
    </style>

    <style>
        .card-stepper {
            z-index: 0
        }

        #progressbar-2 {
            color: #455A64;
        }

        #progressbar-2 li {
            list-style-type: none;
            font-size: 13px;
            width: 33.33%;
            float: left;
            position: relative;
        }

        #progressbar-2 #step1:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-left: 0px;
            padding-left: 0px;
        }

        #progressbar-2 #step2:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
        }

        #progressbar-2 #step3:before {
            content: '\f058';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-right: 0;
            text-align: center;
        }

        #progressbar-2 #step4:before {
            content: '\f111';
            font-family: "Font Awesome 5 Free";
            color: #fff;
            width: 37px;
            margin-right: 0;
            text-align: center;
        }

        #progressbar-2 li:before {
            line-height: 37px;
            display: block;
            font-size: 12px;
            background: #c5cae9;
            border-radius: 50%;
        }

        #progressbar-2 li:after {
            content: '';
            width: 100%;
            height: 10px;
            background: #c5cae9;
            position: absolute;
            left: 0%;
            right: 0%;
            top: 15px;
            z-index: -1;
        }

        #progressbar-2 li:nth-child(1):after {
            left: 1%;
            width: 100%
        }

        #progressbar-2 li:nth-child(2):after {
            left: 1%;
            width: 100%;
        }

        #progressbar-2 li:nth-child(3):after {
            left: 1%;
            width: 100%;
            background: #c5cae9 !important;
        }

        #progressbar-2 li:nth-child(4) {
            left: 0;
            width: 37px;
        }

        #progressbar-2 li:nth-child(4):after {
            left: 0;
            width: 0;
        }

        #progressbar-2 li.active:before,
        #progressbar-2 li.active:after {
            background: #6520ff;
        }
    </style>

    <div class="profile-session-container">
        <div class="container-fluid">
            <div class="dashboard">
                <!-- Sidebar -->
                <%- include("../../partials/profileSideBar") %>

                <!-- Main Content -->
                <div class="container w-75 h-100 my-5 py-4 rounded shadow-lg bg-light">
                    <h2 class="section-title">Order Details</h2>

                    <div class="container mt-5 pt-5">




                        <div class="order-header">
                            <div class="order-info">
                                <h2 class="order-id">#<%= order.orderId%>
                                </h2>
                                <div class="order-date">
                                    Ordered on: <%= new Date(order.createdOn).toLocaleDateString('en-US', {
                                        weekday: 'long' , year: 'numeric' , month: 'long' , day: 'numeric' ,
                                        hour: '2-digit' , minute: '2-digit' }) %>
                                </div>
                            </div>
                            <div class="status-wrapper">
                                <span class="order-status status <%= order.orderStatus.toLowerCase() %>">
                                    <%= order.orderStatus %>
                                </span>
                            </div>
                        </div>

                        <div class="timeline-section">
                            <% if (order.orderStatus.toLowerCase() !=='cancelled' ) { %>
                                <section class="vh-50">
                                    <div class="container py-5 h-100">
                                        <div class="row d-flex justify-content-center align-items-center h-100">
                                            <div class="col-12">
                                                <div class="card card-stepper" style="border-radius: 16px;">
                                                    <div class="card-body p-5">
                                                        <div
                                                            class="d-flex justify-content-between align-items-center mb-5">
                                                            <div>
                                                                <h5 class="mb-0">ORDER TRACKING</h5>
                                                            </div>
                                                            <div class="text-end">
                                                                <p class="mb-0">Order Date: <%= new
                                                                        Date(order.createdOn).toLocaleDateString() %>
                                                                </p>
                                                                <p class="mb-0">Order ID: #<%= order.orderId %>
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <% let steps={ 'pending' : 1, 'processing' : 2, 'shipped' :
                                                            3, 'delivered' : 4 }; let
                                                            currentStep=steps[order.orderStatus.toLowerCase()] || 0; %>

                                                            <ul id="progressbar-2"
                                                                class="d-flex justify-content-between mx-0 mt-0 mb-5 px-0 pt-0 pb-2">
                                                                <li class="step0 <%= currentStep >= 1 ? 'active' : '' %> text-center"
                                                                    id="step1"></li>
                                                                <li class="step0 <%= currentStep >= 2 ? 'active' : '' %> text-center"
                                                                    id="step2"></li>
                                                                <li class="step0 <%= currentStep >= 3 ? 'active' : '' %> text-center"
                                                                    id="step3"></li>
                                                                <li class="step0 <%= currentStep >= 4 ? 'active' : '' %> text-end"
                                                                    id="step4"></li>
                                                            </ul>

                                                            <div class="d-flex justify-content-between">
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-clipboard-list fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Pending</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-box-open fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Processing</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-shipping-fast fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Shipped</p>
                                                                    </div>
                                                                </div>
                                                                <div class="d-lg-flex align-items-center">
                                                                    <i
                                                                        class="fas fa-home fa-3x me-lg-4 mb-3 mb-lg-0"></i>
                                                                    <div>
                                                                        <p class="fw-bold mb-1">Order</p>
                                                                        <p class="fw-bold mb-0">Delivered</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <% } %>
                        </div>



                        <div class="products-list">
                            <div class="product-item product-header">
                                <div>Image</div>
                                <div>Product Details</div>
                                <div>Size</div>
                                <div>Quantity</div>
                                <div>Payment Status</div>
                                <div>Order Status</div>
                                <div>Price</div>
                                <div>Action</div>
                            </div>
                            <% order.orderedItems.forEach((item, index)=> { %>
                                <div class="product-item <%= item.orderStatus === 'Cancelled' ? 'Cancelled' : '' %>">
                                    <div>
                                        <img src="/product-images/<%= item.product.productImages[0] %>"
                                            alt="<%= item.product.productName %>" class="product-image">
                                    </div>
                                    <div class="product-details">
                                        <span class="product-name">
                                            <%= item.product.productName %>
                                        </span>
                                        <span class="product-id">Brand: <%= item.product.brand || 'N/A' %></span>
                                    </div>
                                    <div>
                                        <%= item.size %>
                                    </div>
                                    <div>
                                        <%= item.quantity %>
                                    </div>
                                    <div>
                                        <% if (item.paymentStatus==='Paid' ) { %>
                                            <span class="badge bg-success text-white">Paid</span>
                                            <% } else if (item.paymentStatus==='Refunded' ) { %>
                                                <span class="badge bg-info text-white">Refunded</span>
                                                <% } else if (item.paymentStatus==='Failed' ) { %>
                                                    <span class="badge bg-danger text-white">Failed</span>
                                                    <% } else { %>
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                                        <% } %>
                                    </div>
                                    <div>
                                        <% if (item.orderStatus==='Pending' ) { %>
                                            <span class="badge bg-warning text-dark">Pending</span>
                                            <% } else if (item.orderStatus==='Processing' ) { %>
                                                <span class="badge bg-warning text-dark">Processing</span>
                                                <% } else if (item.orderStatus==='Shipped' ) { %>
                                                    <span class="badge bg-info text-dark">Shipped</span>
                                                    <% } else if (item.orderStatus==='Delivered' ) { %>
                                                        <span class="badge bg-success text-white">Delivered</span>
                                                        <% } else if (item.orderStatus==='Cancelled' ) { %>
                                                            <span class="badge bg-danger text-white">Cancelled</span>
                                                            <% } else if (item.orderStatus==='Return Request' ) { %>
                                                                <span class="badge bg-info text-dark">Return
                                                                    Requested</span>
                                                                <% } else if (item.orderStatus==='Returned' ) { %>
                                                                    <span
                                                                        class="badge bg-success text-white">Returned</span>
                                                                    <% } %>
                                    </div>
                                    <div>₹<%= (item.price * item.quantity).toFixed(2) %>
                                    </div>
                                    <div>
                                        <% if ((item.orderStatus==='Pending' || item.orderStatus==='Processing' ) && item.orderStatus !=='Cancelled' ) { %>
                                            <button class="cancel-product-btn"
                                                onclick="confirmCancelProduct('<%= order._id %>', '<%= index %>')">
                                                Cancel Item
                                            </button>
                                            <% } else if (item.orderStatus==='Delivered' ) { %>
                                                <button class="return-product-btn btn btn-sm btn-outline-info"
                                                    onclick="confirmReturnProduct('<%= order._id %>', '<%= index %>')">
                                                    Return Item
                                                </button>
                                                <% }else if (item.orderStatus === 'Returned'){ %>
                                                    <p class="badge bg-success">Return Successfully</p>
                                                    <% } %>
                                    </div>
                                </div>
                                <% }); %>
                        </div>

                        <div class="address-section">
                            <h3 class="section-title">Shipping Address</h3>
                            <p class="text-center">
                                <strong>
                                    <%= order.address.name %>
                                </strong> <br>
                                <%= order.address.addressType %> Address <br>
                                    <%= order.address.landMark %>, <%= order.address.city %>, <%= order.address.state %>
                                                -
                                                <%= order.address.pincode %> <br>
                                                    Phone: <%= order.address.phone %> <br>
                                                        Alt Phone: <%= order.address.altPhone %>
                            </p>
                        </div>


                        <div class="total-section">
                            <h3 class="section-title">Order Summary</h3>
                            <div class="summary-details">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>₹<%= order.subtotal.toFixed(2) %></span>
                                </div>
                                <div class="summary-row text-success">
                                    <span>Discount:</span>
                                    <span>-₹<%= order.discount.toFixed(2) %></span>
                                </div>
                                <div class="summary-row">
                                    <span>Shipping:</span>
                                    <span>₹<%= order.shippingCharge || 0 %></span>
                                </div>
                                <div class="summary-row font-weight-bold">
                                    <span>Total Amount:</span>
                                    <span>₹<%= order.totalPrice.toFixed(2) %></span>
                                </div>
                            </div>
                        
                            <% if (order.paymentStatus === 'Paid' && order.orderStatus === 'Delivered') { %>
                                <button class="btn btn-primary mt-3" onclick="downloadInvoice('<%= order._id %>')">
                                    Download Invoice
                                </button>
                            <% } %>
                        </div>

                        <a href="/orders" class="back-btn">Back to Orders</a>

                        <% if (order.orderStatus.toLowerCase()==='pending' || order.orderStatus.toLowerCase()==='processing' ) { %>
                            <button class="cancel-btn" onclick="confirmCancelOrder('<%= order._id %>')">Cancel
                                Order</button>
                            <% }  %>
                                
                                
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmCancelOrder(orderId) {
            Swal.fire({
                title: 'Cancel Entire Order?',
                text: `Please provide a reason for canceling order ${orderId}:`,
                input: 'textarea',
                inputPlaceholder: 'Enter your reason here...',
                inputAttributes: {
                    'aria-label': 'Reason for canceling order',
                },
                showCancelButton: true,
                confirmButtonText: 'Submit',
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                preConfirm: (reason) => {
                    if (!reason) {
                        Swal.showValidationMessage('Reason is required');
                    }
                    return reason;
                },
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelOrder(orderId, result.value); // Pass the reason to the cancelOrder function
                }
            });
        }

        function cancelOrder(orderId, reason) {
            fetch(`/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        Swal.fire('Cancelled!', 'The order has been cancelled.', 'success').then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire('Error!', 'Failed to cancel the order.', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    Swal.fire('Error!', 'Something went wrong.', 'error');
                });
        }

        // function confirmReturnOrder(orderId) {
        //     Swal.fire({
        //         title: 'Return Order?',
        //         text: `Please provide a reason for returning order ${orderId}:`,
        //         input: 'textarea',
        //         inputPlaceholder: 'Enter your reason here...',
        //         inputAttributes: {
        //             'aria-label': 'Reason for returning order',
        //         },
        //         showCancelButton: true,
        //         confirmButtonText: 'Submit',
        //         confirmButtonColor: '#d33',
        //         cancelButtonColor: '#3085d6',
        //         preConfirm: (reason) => {
        //             if (!reason) {
        //                 Swal.showValidationMessage('Reason is required');
        //             }
        //             return reason;
        //         },
        //     }).then((result) => {
        //         if (result.isConfirmed) {
        //             returnOrder(orderId, result.value); // Pass the reason to the returnOrder function
        //         }
        //     });
        // }

        // function returnOrder(orderId, reason) {
        //     fetch(`/orders/${orderId}/return`, {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify({ reason }),
        //     })
        //         .then((response) => response.json())
        //         .then((data) => {
        //             if (data.success) {
        //                 Swal.fire('Returned!', 'The order has been returned successfully.', 'success').then(() => {
        //                     window.location.reload();
        //                 });
        //             } else {
        //                 Swal.fire('Error!', 'Failed to return the order.', 'error');
        //             }
        //         })
        //         .catch((error) => {
        //             console.error('Error:', error);
        //             Swal.fire('Error!', 'Something went wrong.', 'error');
        //         });
        // }





        // PRODUCT CANCEL AND RETURN FUNCTIONS


        function confirmCancelProduct(orderId, productIndex) {
            Swal.fire({
                title: 'Cancel Product?',
                input: 'text',
                inputLabel: 'Reason for cancellation',
                inputPlaceholder: 'Enter your reason...',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel item',
                cancelButtonText: 'No, keep it',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Reason is required!';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    cancelProduct(orderId, productIndex, result.value);
                }
            });
        }

        function cancelProduct(orderId, productIndex, reason) {
            fetch(`/orders/${orderId}/products/${productIndex}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Cancelled!', 'The product has been cancelled.', 'success')
                            .then(() => window.location.reload());
                    }
                })
                .catch(error => Swal.fire('Error!', error.message || 'Something went wrong.', 'error'));
        }



        function confirmReturnProduct(orderId, productIndex) {
            Swal.fire({
                title: 'Return Product?',
                input: 'text',
                inputLabel: 'Reason for return',
                inputPlaceholder: 'Enter your reason...',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, return item',
                cancelButtonText: 'No, keep it',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Reason is required!';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    returnProduct(orderId, productIndex, result.value);
                }
            });
        }

        function returnProduct(orderId, productIndex, reason) {
            fetch(`/orders/${orderId}/products/${productIndex}/return`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Returned!', 'The product has been returned.', 'success')
                            .then(() => window.location.reload());
                    }
                })
                .catch(error => Swal.fire('Error!', error.message || 'Something went wrong.', 'error'));
        }
    </script>

<script>
    function downloadInvoice(orderId) {
        fetch(`/orders/${orderId}/invoice`, {
            method: 'GET',
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoice_${orderId}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error!', 'Failed to download the invoice.', 'error');
        });
    }
</script>

    <%- include("../../partials/footer") %>