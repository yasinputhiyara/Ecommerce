<%- include("../partials/header") %>

  <link rel="stylesheet" href="/user/stylesheets/cart.css">
  <link rel="stylesheet" href="/user/essence/css/core-style.css">

  <!-- ##### Breadcumb Area Start ##### -->
  <div class="breadcumb_area bg-img" style="background-image: url(/user/essence/img/bg-img/breadcumb.jpg)">
    <div class="container h-100">
      <div class="row h-100 align-items-center">
        <div class="col-12">
          <div class="page-title text-center">
            <h2>Cart</h2>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ##### Breadcumb Area End ##### -->
  <section class="shopping-cart">
    <div class="container">
      <div class="content">
        <h2>Shopping Cart</h2>
        <div class="row">
          <!-- Left Column: Product Table -->
          <div class="col-md-8">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Product Name</th>
                    <th>Product Size</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (cartData && cartData.items.length> 0) { %>
                    <% cartData.items.forEach(item=> { %>
                      <tr>
                        <td>
                          <img src="/resized-images/<%= item.productId.productImages[0] %>"
                            alt="<%= item.productId.productName %>" style="width: 60px;">


                        </td>
                        <td>
                          <%= item.productId.productName %>
                        </td>
                        <td>
                          <%= item.size %>
                        </td>
                        <td>&#8377;<%= item.price %>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-dark decrement"
                            data-product-id="<%= item.productId._id %>">-</button>
                          <span class="mx-2 quantity" data-product-id="<%= item.productId._id %>">
                            <%= item.quantity %>
                          </span>
                          <button class="btn btn-sm btn-dark increment"
                            data-product-id="<%= item.productId._id %>">+</button>
                        </td>

                        <td>&#8377;<%= item.price * item.quantity %>
                        </td>
                        <td>

                          <button class="btn btn-sm btn-danger"
                            onclick="removeCartItem('<%= item._id %>')">Remove</button>

                        </td>
                      </tr>
                      <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="6" class="text-center">Your cart is empty</td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Right Column: Order Summary -->
          <div class="col-md-4">
            <div class="summary">
              <h3>Order Summary</h3>
              <div class="summary-item">
                <span>Subtotal</span>
                <span>
                  &#8377;<%= cartData ? cartData.items.reduce((acc, item)=> acc + (item.price * item.quantity), 0) : 0
                    %>
                </span>
              </div>
              <div class="summary-item">
                <span>Discount</span>
                <span>&#8377;0</span>
              </div>
              <div class="summary-item">
                <span>Shipping</span>
                <span>&#8377;50</span>
              </div>
              <div class="summary-item">
                <span>Total</span>
                <span>
                  &#8377;<%= cartData ? cartData.items.reduce((acc, item)=> acc + (item.price * item.quantity), 0) + 50
                    : 0 %>
                </span>
              </div>
              <a href="/checkout" class="btn btn-primary mt-3">Proceed to Checkout</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const updateCart = async (productId, newQuantity) => {
        try {
          const response = await fetch('/update-cart', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ productId, quantity: newQuantity }),
          });
          const data = await response.json();
          if (data.success) {
            // Use SweetAlert for success
            // Swal.fire({
            //   icon: 'success',
            //   title: 'Cart Updated!',
            //   text: 'Your cart has been updated successfully.',
            //   confirmButtonText: 'Okay'
            // }).then(() => {
            //   location.reload(); 
            // });
              location.reload(); 
          } else {
            // Use SweetAlert for failure
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: data.message || 'Failed to update cart',
              confirmButtonText: 'Try Again'
            });
          }
        } catch (error) {
          console.error('Error updating cart:', error);
          // Use SweetAlert for unexpected errors
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An unexpected error occurred while updating the cart.',
            confirmButtonText: 'Okay'
          });
        }
      };

      document.querySelectorAll('.increment').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.getAttribute('data-product-id');
          const quantityElement = document.querySelector(`.quantity[data-product-id="${productId}"]`);
          const currentQuantity = parseInt(quantityElement.textContent, 10);
          const newQuantity = currentQuantity + 1;
          quantityElement.textContent = newQuantity;
          updateCart(productId, newQuantity);
        });
      });

      document.querySelectorAll('.decrement').forEach(button => {
        button.addEventListener('click', () => {
          const productId = button.getAttribute('data-product-id');
          const quantityElement = document.querySelector(`.quantity[data-product-id="${productId}"]`);
          const currentQuantity = parseInt(quantityElement.textContent, 10);
          const newQuantity = Math.max(1, currentQuantity - 1); // Prevent quantity < 1
          quantityElement.textContent = newQuantity;
          updateCart(productId, newQuantity);
        });
      });
    });

    // <!-- REMOVE ITEM FROM CART -->
    // REMOVE ITEM FROM CART FUNCTION
    const removeCartItem = async (itemId) => {
      try {
        const response = await fetch(`/remove-from-cart/${itemId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Item Removed!',
            text: 'The item has been removed from your cart.',
            confirmButtonText: 'Okay',
          }).then(() => {
            location.reload(); // Reload the page to reflect changes
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message || 'Failed to remove item from cart.',
            confirmButtonText: 'Try Again',
          });
        }
      } catch (error) {
        console.error('Error removing item from cart:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'An unexpected error occurred while removing the item.',
          confirmButtonText: 'Okay',
        });
      }
    };


  </script>





  <!--</script>  SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>






  <%- include("../partials/footer") %>