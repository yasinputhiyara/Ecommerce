<%- include("../partials/adminheader") %>
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.min.css'>
  </link>

  <div class="container-scroller">
    <!-- Sidebar -->
    <%- include("../partials/adminSidebar") %>

      <div class="container-fluid page-body-wrapper">
        <!-- Navbar -->
        <%- include("../partials/adminNav") %>

          <div class="main-panel">
            <div class="content-wrapper bg-light">

              <!-- Page Header -->
              <div class="page-header">
                <h3 class="page-title">Product Management</h3>
                <a href="/admin/add-product" class="btn btn-primary">Add Product</a>
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb" style="color: red;">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page"><a href="#">Products</a></li>
                  </ol>
                </nav>
              </div>

              <!-- Search Bar -->
              <!-- Search Bar -->
              <div class="content-header text-center">
                <form action="" method="get" class="d-inline">
                  <div class="input-group input-group-sm border border-1 border-grey rounded-pill"
                    style="width: 500px; margin: auto;">
                    <input type="text" class="form-control border-0 rounded-pill" placeholder="Search products"
                      name="search" value="<%= searchQuery %>" /> <!-- Preserve search input -->
                    <button class="btn border-0" type="submit">Search</button>
                  </div>
                </form>
              </div>


              <!-- Product Table -->
              <div class="right mt-5">
                <h2 class="content-title card-title text-center mb-4">Product List</h2>
                <table class="table table-striped table-bordered text-center">
                  <thead class="thead-dark">
                    <tr>
                      <th>#</th>
                      <th scope="col">Product Name</th>
                      <th sccope="col">Product Offer</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% for (let i=0; i < data.length; i++) { %>

                      <tr>
                        <td>
                          <%= i+1 %>
                        </td>
                        <!-- Product Name -->
                        <td>
                          <%= data[i].productName %>
                        </td>


                        <!-- Product Offer -->
                        <td>
                          <% if (data[i].productOffer ) { %>
                            <span class="badge bg-success">
                              <%= data[i].productOffer %>
                            </span>
                            <% } else { %>
                              <span class="badge bg-danger"> 0% </span>
                              <% } %>


                                <% if(locals.data[i].productOffer===0) {%>
                                  <button class="btn btn-info" onclick="addOffer('<%= data[i]._id %>')"
                                    style="width: 100px;">
                                    <a href="#" class="text-white">Add Offer</a>
                                  </button>
                                  <% }else{ %>
                                    <button class="btn btn-info" onclick="removeOffer('<%= data[i]._id %>') "
                                      style="width: 100px;">
                                      <a href="#" class="text-white">Remove</a>
                                    </button>
                                    <% } %>

                        </td>






                        <!-- Actions -->
                        <td>
                          <!-- View Details Button -->
                          <button class="btn btn-info text-white me-2" data-bs-toggle="modal"
                            data-bs-target="#productModal<%= i %>">
                            View Details
                          </button>

                          <!-- Block/Unblock Button -->
                          <% if (!data[i].isBlocked) { %>
                            <a href="/admin/blockProduct?id=<%= data[i]._id %>" class="btn btn-danger text-white me-2"
                              style="text-decoration: none;">
                              Block
                            </a>
                            <% } else { %>
                              <a href="/admin/unblockProduct?id=<%= data[i]._id %>"
                                class="btn btn-success text-white me-2" style="text-decoration: none;">
                                Unblock
                              </a>
                              <% } %>

                                <!-- Edit Button -->
                                <a href="/admin/edit-product/<%= data[i]._id %>" class="btn btn-primary text-white"
                                  style="text-decoration: none;">
                                  Edit
                                </a>
                        </td>
                      </tr>

                      <!-- Product Details Modal -->

                      <div class="modal fade" id="productModal<%= i %>" tabindex="-1"
                        aria-labelledby="productModalLabel<%= i %>" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="productModalLabel<%= i %>">
                                <%= data[i].productName %>
                              </h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p><strong>Brand:</strong>
                                <%= data[i].brand %>
                              </p>
                              <p><strong>Category:</strong>
                                <%= data[i].category.name %>
                              </p>
                              <p><strong>Sale Price:</strong>
                                <%= data[i].salePrice %>
                              </p>
                              <p><strong>Regular Price:</strong>
                                <%= data[i].regularPrice %>
                              </p>
                              <p><strong>Varients:</strong>
                                <br>
                                <% for(let j=0; j < data[i].variants.length; j++) { %>
                                  Size <%= data[i].variants[j].size %>: Quantity <%= data[i].variants[j].quantity %>
                                      <br>
                                      <% } %>
                              </p>
                              <p><strong>Description:</strong>
                                <%= data[i].description %>
                              </p>
                              <p><strong>Status:</strong>
                                <%= data[i].isBlocked ? "Blocked" : "Active" %>
                              </p>
                              <div>
                                <strong>Product Images:</strong>
                                <div class="d-flex flex-wrap">
                                  <% for (let image of data[i].productImages) { %>
                                    <img src="/product-images/<%= image %>" alt="Product Image"
                                      class="img-thumbnail m-2" style="width: 150px; height: 150px;">
                                    <% } %>
                                </div>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>

                      <% } %>
                  </tbody>
                </table>
              </div>

              <!-- Pagination Section -->
              <div class="pagination mt-4">
                <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center">
                    <!-- Previous Page -->
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                      <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= searchQuery %>"
                        aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                      </a>
                    </li>

                    <!-- Page Numbers -->
                    <% for (let i=1; i <=totalPages; i++) { %>
                      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>&search=<%= searchQuery %>">
                          <%= i %>
                        </a>
                      </li>
                      <% } %>

                        <!-- Next Page -->
                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                          <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= searchQuery %>"
                            aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                  </ul>
                </nav>
              </div>



            </div>
          </div>
      </div>
  </div>


  <script>
    // Function to add a product offer
    async function addOffer(productId) {
      const { value: amount } = await Swal.fire({
        title: "Add Offer",
        input: "number",
        inputLabel: "Enter offer percentage",
        inputPlaceholder: "%",
        confirmButtonText: "Apply Offer",
        showCancelButton: true,
      });
  
      if (amount) {
        $.ajax({
          url: "/admin/addProductOffer",
          method: "post",
          data: {
            percentage: amount,
            productId: productId,
          },
          success: (response) => {
            if (response.status === true) {
              Swal.fire("Success", "Offer added successfully!", "success").then(() => {
                location.reload();
              });
            } else {
              Swal.fire("Failed", response.message || "Unable to add offer.", "error");
            }
          },
          error: () => {
            Swal.fire("Error", "An error occurred while adding the offer.", "error");
          },
        });
      }
    }
  
    // Function to remove a product offer
    function removeOffer(productId) {
      Swal.fire({
        title: "Remove Offer",
        text: "Are you sure you want to remove this offer?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, Remove It!",
        cancelButtonText: "Cancel",
        timer: 5000, // Use 'timer' instead of 'time'
        timerProgressBar: true,
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: "/admin/removeProductOffer",
            method: "post",
            data: { productId: productId },
            success: (response) => {
              if (response.status === true) {
                Swal.fire("Removed", "The offer has been removed.", "success").then(() => {
                  location.reload();
                });
              } else {
                Swal.fire("Failed", response.message || "Unable to remove offer.", "error");
              }
            },
            error: () => {
              Swal.fire("Error", "An error occurred while removing the offer.", "error");
            },
          });
        }
      });
    }
  </script>
  



  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <%- include("../partials/adminfooter") %>