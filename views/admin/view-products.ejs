<%- include("../partials/adminheader") %>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.min.css'></link>



<div class="container-scroller">
  <!-- Sidebar -->
  <%- include("../partials/adminSidebar") %>

  <div class="container-fluid page-body-wrapper">
    <!-- Navbar -->
    <%- include("../partials/adminNav") %>

    <div class="main-panel">
      <div class="content-wrapper">
        
        <!-- Page Header -->
        <div class="page-header">
          <h3 class="page-title">Product Management</h3>
          <a href="/admin/add-product" class="btn btn-primary">Add Product</a>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
              <li class="breadcrumb-item active" aria-current="page">Products</li>
            </ol>
          </nav>
        </div>

        <!-- Search Bar -->
        <div class="content-header text-center">
          <form action="" method="get" class="d-inline">
            <div class="input-group input-group-sm border border-1 border-grey rounded-pill" style="width: 500px; margin: auto;">
              <input 
                type="text" 
                class="form-control border-0 rounded-pill" 
                placeholder="Search products or brands" 
                name="search" 
              />
              <button class="btn border-0" type="submit">Search</button>
            </div>
          </form>
        </div>

        <!-- Product Table -->
        <div class="right mt-5">
          <h2 class="content-title card-title text-center mb-4">Product List</h2>
          <table class="table table-striped table-bordered text-center">
            <thead class="thead-dark">
              <tr>
                <th scope="col">Product Name</th>
                <th scope="col">Brand</th>
                <th scope="col">Category</th>
                <th scope="col">Sale Price</th>
                <th scope="col">Regular Price</th>
                <th scope="col">Quantity</th>
                <!-- <th scope="col">Offer</th> -->
                <th scope="col">Action</th>
                <th scope="col">Edit</th>
              </tr>
            </thead>
            <tbody>
              <% for (let i = 0; i < data.length; i++) { %>
              <tr>
                <!-- Product Details -->
                <td><%= data[i].productName %></td>
                <td><%= data[i].brand %></td>
                <td><%= data[i].category.name %></td>
                <td><%= data[i].salePrice %></td>
                <td><%= data[i].regularPrice %></td>
                <td><%= data[i].quantity %></td>

                <!-- Product Offer -->
                <!-- <td>
                  <% if (locals.data[i].productOffer) { %>
                    <%= data[i].productOffer %>
                  <% } else { %>
                    0%
                  <% } %>
                </td> -->

                <!-- Add/Remove Offer -->
                <!-- <td>
                  <% if (locals.data[i].productOffer === 0) { %>
                  <button 
                    class="btn btn-info text-white" 
                    onclick="addOffer('<%= data[i]._id %>')" 
                    style="width: 100px;">
                    Add Offer
                  </button>
                  <% } else { %>
                  <button 
                    class="btn btn-warning text-white" 
                    onclick="removeOffer('<%= data[i]._id %>')" 
                    style="width: 100px;">
                    Remove Offer
                  </button>
                  <% } %>
                </td> -->

                <!-- Block/Unblock Product -->
                <td>
                  <% if (!data[i].isBlocked) { %>
                  <button class="btn btn-danger">
                    <a 
                      href="/admin/blockProduct?id=<%= data[i]._id %>" 
                      class="text-white" 
                      style="text-decoration: none;">
                      Block
                    </a>
                  </button>
                  <% } else { %>
                  <button class="btn btn-success">
                    <a 
                      href="/admin/unblockProduct?id=<%= data[i]._id %>" 
                      class="text-white" 
                      style="text-decoration: none;">
                      Unblock
                    </a>
                  </button>
                  <% } %>
                </td>

                <!-- Edit Product -->
                <td>
                  <button class="btn btn-primary">
                    <a 
                      href="/admin/edit-product/?id=<%= data[i]._id %>" 
                      class="text-white" 
                      style="text-decoration: none;">
                      Edit
                    </a>
                  </button>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  async function addOffer(productId) {
    const { value: amount } = await Swal.fire({
      title: "Add Offer",
      input: 'number',
      inputLabel: 'Percentage',
      inputPlaceholder: '%'
    });

    if (amount) {
      $.ajax({
        url: "/admin/addProductOffer",
        method: "post",
        data: { percentage: amount, productId: productId },
        success: (response) => {
          if (response.status === true) {
            Swal.fire('Success', 'Offer added successfully!', 'success');
            location.reload();
          } else {
            Swal.fire('Error', 'Failed to add offer!', 'error');
          }
        }
      });
    }
  }

  function removeOffer(productId) {
    Swal.fire({
      title: "Remove Offer",
      text: "Are you sure you want to remove this offer?",
      showCancelButton: true,
      confirmButtonText: "Yes"
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: "/admin/removeProductOffer",
          method: "post",
          data: { productId: productId },
          success: (response) => {
            if (response.status === true) {
              Swal.fire('Success', 'Offer removed successfully!', 'success');
              location.reload();
            } else {
              Swal.fire('Error', 'Failed to remove offer!', 'error');
            }
          }
        });
      }
    });
  }
</script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<%- include("../partials/adminfooter") %>
