document.addEventListener('DOMContentLoaded', function() {
  const productForm = document.getElementById('productForm');
  if (productForm) {
      productForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          // Collect variants data
          const variants = [];
          document.querySelectorAll('.variant').forEach(variantDiv => {
              const size = variantDiv.querySelector('select[name="size"]').value;
              const quantity = variantDiv.querySelector('input[name="quantity"]').value;
              
              if (size && quantity) {
                  variants.push({
                      size: size,
                      quantity: parseInt(quantity)
                  });
              }
          });

          // Create FormData and append all form data
          const formData = new FormData(this);
          
          // Remove individual variant fields and append as JSON
          formData.delete('size');
          formData.delete('quantity');
          formData.append('variants', JSON.stringify(variants));

          // Handle cropped images
          if (croppedImages && croppedImages.size > 0) {
              for (const [inputId, imageData] of croppedImages.entries()) {
                  // Convert blob to file with a unique name
                  const fileName = `cropped_${Date.now()}_${inputId}.jpg`;
                  const imageFile = new File([imageData.blob], fileName, { type: 'image/jpeg' });
                  formData.append('images', imageFile);
              }
          }

          const productId = window.location.pathname.split('/').pop();

          try {
              const response = await fetch(`/admin/edit-product/${productId}`, {
                  method: 'PUT',
                  body: formData
              });

              const data = await response.json();

              if (data.success) {
                  Swal.fire({
                      icon: 'success',
                      title: 'Success',
                      text: 'Product updated successfully'
                  }).then(() => {
                      window.location.href = '/admin/view-products';
                  });
              } else {
                  throw new Error(data.message || 'Failed to update product');
              }
          } catch (error) {
              console.error('Error:', error);
              Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: error.message || 'Failed to update product'
              });
          }
      });
  }
});